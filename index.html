<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RenoBros Quotation System</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <style>
        :root {
            --primary: #0f172a;
            --primary-light: #334155;
            --accent: #2563eb;
            --bg-app: #f1f5f9;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        .app-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .brand-logo {
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand-logo span { color: var(--accent); }

        /* --- CONTAINER --- */
        .main-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 15px;
        }

        /* --- CARD --- */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }

        .input-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .input-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--text-main);
            transition: border-color 0.2s;
            background: #fff;
        }
        .input-control:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* --- SECTIONS --- */
        .section-block {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .section-title-bar {
            background: #f8fafc;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .section-title-input {
            background: transparent;
            border: none;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
            width: 70%;
        }
        .section-total {
            font-weight: 700;
            color: var(--text-main);
        }

        .item-row {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        .item-row:last-child { border-bottom: none; }
        
        .item-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 10px;
        }
        .item-desc {
            width: 100%;
            border: none;
            resize: none;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--text-main);
            background: transparent;
            min-height: 24px;
        }
        
        .item-metrics {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .metric-box { position: relative; }
        .metric-box span {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: var(--text-muted);
            pointer-events: none;
        }
        .metric-input {
            width: 80px;
            padding: 8px 8px 8px 24px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: right;
            font-size: 0.9rem;
            -moz-appearance: textfield;
        }
        .metric-input::-webkit-outer-spin-button,
        .metric-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .unit-input { width: 60px; padding: 8px; text-align: center; }

        .btn-icon-danger {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .section-actions {
            padding: 10px 20px;
            background: #fff;
            display: flex;
            gap: 15px;
            border-top: 1px solid var(--border);
        }
        .btn-text {
            background: none;
            border: none;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 0;
        }

        .add-section-area { text-align: center; margin: 30px 0; }
        .btn-dashed {
            width: 100%;
            border: 2px dashed var(--border);
            background: transparent;
            padding: 15px;
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-dashed:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(37, 99, 235, 0.05);
        }

        /* --- FOOTER --- */
        .footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        .grand-total-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .grand-total-value { font-size: 1.3rem; font-weight: 800; color: var(--primary); }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(2px);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }
        .modal-overlay.active { display: flex; }
        .modal-card {
            background: white;
            width: 100%;
            max-width: 600px;
            height: 85vh;
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            padding-bottom: env(safe-area-inset-bottom);
        }
        @media(min-width: 600px) {
            .modal-overlay { align-items: center; }
            .modal-card { height: 70vh; border-radius: 12px; }
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body { flex: 1; overflow: hidden; display: flex; }
        .cat-sidebar { width: 35%; background: #f8fafc; border-right: 1px solid var(--border); overflow-y: auto; }
        .cat-btn {
            width: 100%; text-align: left; padding: 15px; border: none; background: none;
            border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 600; cursor: pointer; font-size: 0.8rem;
        }
        .cat-btn.active { background: white; color: var(--accent); border-left: 3px solid var(--accent); }
        .item-list { width: 65%; overflow-y: auto; }
        .template-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .t-desc { font-size: 0.9rem; font-weight: 500; margin-bottom: 4px; }
        .t-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; }
        
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<header class="app-header">
    <div class="brand-logo"><i class="fas fa-layer-group"></i> RenoBros<span>Interior</span></div>
    <div style="font-size: 0.8rem; color: var(--text-muted);">Quotation Builder</div>
</header>

<div class="main-container">
    <div class="card">
        <div class="card-header">Project Details</div>
        <div class="form-grid">
            <div class="input-group">
                <label>Client Name</label>
                <input type="text" id="clientName" class="input-control" value="Mr. Julian">
            </div>
            <div class="input-group">
                <label>Quote Ref</label>
                <input type="text" id="quoteRef" class="input-control" value="RB-2025-001">
            </div>
            <div class="input-group">
                <label>Property Address</label>
                <input type="text" id="address" class="input-control" value="33 Tanglin Road, #10-09">
            </div>
            <div class="input-group">
                <label>Date</label>
                <input type="date" id="quoteDate" class="input-control">
            </div>
            <div class="input-group" style="grid-column: span 2;">
                <label>Project Title (Cover Page)</label>
                <input type="text" id="projectTitle" class="input-control" value="PROPOSED RENOVATION WORKS AT 33 TANGLIN ROAD, #10-09">
            </div>
        </div>
    </div>

    <div id="sections-container"></div>

    <div class="add-section-area">
        <button class="btn-dashed" onclick="addNewSection()">
            <i class="fas fa-plus"></i> Add New Section
        </button>
    </div>
</div>

<div class="footer-bar">
    <div>
        <div class="grand-total-label">Grand Total</div>
        <div class="grand-total-value" id="ui-grand-total">$0.00</div>
    </div>
    <button class="btn-primary" id="btn-generate" onclick="generatePDF()">
        <i class="fas fa-file-pdf"></i> Download PDF
    </button>
</div>

<div id="templateModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <h3 style="margin:0; font-size:1.1rem;">Saved Items Library</h3>
            <button onclick="closeModal()" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div class="cat-sidebar" id="modalCategories"></div>
            <div class="item-list" id="modalItems"></div>
        </div>
    </div>
</div>

<script>
    // === DATA & STATE ===
    const categories = {
        "Preliminaries": [
            { desc: "Project Management & Consultation", unit: "L/S", price: 3500 },
            { desc: "Haulage & Debris Disposal", unit: "L/S", price: 1200 },
            { desc: "Floor Protection (Corrugated Board)", unit: "L/S", price: 600 },
            { desc: "General Cleaning upon handover", unit: "L/S", price: 450 }
        ],
        "Hacking / Demolition": [
            { desc: "Hack existing floor tiles", unit: "ft²", price: 4.50 },
            { desc: "Hack existing kitchen wall tiles", unit: "ft²", price: 3.50 },
            { desc: "Dismantle existing kitchen cabinet", unit: "ft", price: 35 },
            { desc: "Dismantle existing wardrobe", unit: "ft", price: 25 }
        ],
        "Masonry / Flooring": [
            { desc: "Supply & lay 600x600mm Homogeneous Tiles", unit: "ft²", price: 12 },
            { desc: "Supply & lay Vinyl Flooring (5mm click)", unit: "ft²", price: 6.50 },
            { desc: "Construct Kitchen Cabinet Base", unit: "ft", price: 35 }
        ],
        "Carpentry": [
            { desc: "Design & Fabricate Kitchen Cabinet (Btm)", unit: "ft", price: 140 },
            { desc: "Design & Fabricate Kitchen Cabinet (Top)", unit: "ft", price: 140 },
            { desc: "Casement Wardrobe (Internal Colour PVC)", unit: "ft", price: 260 },
            { desc: "Sliding Wardrobe (Internal Colour PVC)", unit: "ft", price: 290 },
            { desc: "Quartz Worktop (Selected Series)", unit: "ft", price: 120 }
        ],
        "Plumbing": [
            { desc: "Install Kitchen Sink & Tap", unit: "No", price: 120 },
            { desc: "Install WC Bowl", unit: "No", price: 120 },
            { desc: "Supply & Run New Stainless Steel Piping (Whole House)", unit: "L/S", price: 1800 }
        ],
        "Electrical": [
            { desc: "Lighting Point (New)", unit: "No", price: 55 },
            { desc: "13A Powerpoint (Single)", unit: "No", price: 60 },
            { desc: "13A Powerpoint (Double)", unit: "No", price: 70 },
            { desc: "Data Point (Cat6)", unit: "No", price: 110 }
        ]
    };

    let quoteData = [
        { 
            id: 1, 
            title: "Preliminaries", 
            items: [
                { id: 101, desc: "Project Management & Consultation", unit: "L/S", price: 3500, qty: 1 },
                { id: 102, desc: "Floor Protection", unit: "L/S", price: 600, qty: 1 }
            ] 
        },
        { 
            id: 2, 
            title: "Demolition Works", 
            items: [
                { id: 201, desc: "Hack existing floor tiles (Living)", unit: "ft²", price: 4.50, qty: 400 }
            ] 
        }
    ];

    let activeSectionId = null;

    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('quoteDate').valueAsDate = new Date();
        renderBuilder();
        setupModal();
    });

    // === RENDER LOGIC ===
    function renderBuilder() {
        const container = document.getElementById('sections-container');
        container.innerHTML = '';
        let grandTotal = 0;

        quoteData.forEach((section, sIndex) => {
            const sectionTotal = section.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            grandTotal += sectionTotal;

            const sectionEl = document.createElement('div');
            sectionEl.className = 'section-block';
            sectionEl.innerHTML = `
                <div class="section-title-bar">
                    <div style="display:flex; align-items:center; gap:10px; flex:1;">
                        <span style="font-weight:700; color:var(--text-muted);">${String.fromCharCode(65 + sIndex)}.</span>
                        <input type="text" class="section-title-input" value="${section.title}" onchange="updateSectionTitle(${section.id}, this.value)">
                    </div>
                    <div class="section-total">${formatCurrency(sectionTotal)}</div>
                </div>
                <div class="items-container">
                    ${section.items.map((item) => `
                        <div class="item-row">
                            <div class="item-top">
                                <textarea class="item-desc" rows="1" onchange="updateItem(${section.id}, ${item.id}, 'desc', this.value)">${item.desc}</textarea>
                                <button class="btn-icon-danger" onclick="deleteItem(${section.id}, ${item.id})"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="item-metrics">
                                <div class="metric-box">
                                    <span>Qty</span>
                                    <input type="number" class="metric-input" value="${item.qty}" onchange="updateItem(${section.id}, ${item.id}, 'qty', this.value)">
                                </div>
                                <div class="metric-box">
                                    <input type="text" class="unit-input metric-input" style="padding-left:6px; width:60px; text-align:center;" value="${item.unit}" onchange="updateItem(${section.id}, ${item.id}, 'unit', this.value)">
                                </div>
                                <div class="metric-box">
                                    <span>$</span>
                                    <input type="number" class="metric-input" value="${item.price}" onchange="updateItem(${section.id}, ${item.id}, 'price', this.value)">
                                </div>
                                <div style="margin-left:auto; font-weight:600; font-size:0.9rem;">
                                    ${formatCurrency(item.qty * item.price)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="section-actions">
                    <button class="btn-text" onclick="openLibrary(${section.id})">
                        <i class="fas fa-book-open"></i> Library
                    </button>
                    <button class="btn-text" style="color:var(--text-muted)" onclick="addBlankItem(${section.id})">
                        <i class="fas fa-plus"></i> Blank Item
                    </button>
                </div>
            `;
            container.appendChild(sectionEl);
        });

        document.getElementById('ui-grand-total').textContent = formatCurrency(grandTotal);
    }

    // === DATA MODIFIERS ===
    function addNewSection() {
        const newId = Date.now();
        quoteData.push({ id: newId, title: "New Section Work", items: [] });
        renderBuilder();
    }
    function updateSectionTitle(id, val) {
        const s = quoteData.find(x => x.id === id); if(s) s.title = val;
    }
    function updateItem(sectionId, itemId, field, val) {
        const s = quoteData.find(x => x.id === sectionId);
        const item = s.items.find(x => x.id === itemId);
        if(item) { item[field] = field==='desc'||field==='unit' ? val : parseFloat(val); renderBuilder(); }
    }
    function deleteItem(sectionId, itemId) {
        const s = quoteData.find(x => x.id === sectionId);
        s.items = s.items.filter(x => x.id !== itemId); renderBuilder();
    }
    function addBlankItem(sectionId) {
        const s = quoteData.find(x => x.id === sectionId);
        s.items.push({ id: Date.now(), desc: "Description of work...", unit: "L/S", price: 0, qty: 1 });
        renderBuilder();
    }

    // === MODAL LOGIC ===
    function setupModal() {
        const catContainer = document.getElementById('modalCategories');
        const keys = Object.keys(categories);
        catContainer.innerHTML = keys.map((k, i) => `
            <button class="cat-btn ${i===0?'active':''}" onclick="showCategory('${k}', this)">${k}</button>
        `).join('');
        showCategory(keys[0], catContainer.firstElementChild);
    }
    function showCategory(catName, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        const list = document.getElementById('modalItems');
        list.innerHTML = categories[catName].map(item => `
            <div class="template-item" onclick="selectTemplateItem('${item.desc}', '${item.unit}', ${item.price})">
                <div class="t-desc">${item.desc}</div>
                <div class="t-meta"><span>${item.unit}</span><span>$${item.price}</span></div>
            </div>
        `).join('');
    }
    function openLibrary(sectionId) { activeSectionId = sectionId; document.getElementById('templateModal').classList.add('active'); }
    function closeModal() { document.getElementById('templateModal').classList.remove('active'); activeSectionId = null; }
    function selectTemplateItem(desc, unit, price) {
        if(!activeSectionId) return;
        const s = quoteData.find(x => x.id === activeSectionId);
        s.items.push({ id: Date.now(), desc, unit, price, qty: 1 });
        renderBuilder(); closeModal();
    }
    function formatCurrency(val) {
        return '$' + Number(val).toLocaleString('en-SG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // === PDF GENERATION (PROFESSIONAL EDITION) ===
    function generatePDF() {
        const btn = document.getElementById('btn-generate');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        btn.disabled = true;

        // 1. Gather Data
        const clientName = document.getElementById('clientName').value;
        const address = document.getElementById('address').value;
        const quoteDate = document.getElementById('quoteDate').value;
        const quoteRef = document.getElementById('quoteRef').value;
        const projectTitle = document.getElementById('projectTitle').value;
        let grandTotal = 0;

        // 2. Build Cover Page Summary Table
        const summaryBody = [];
        // Header
        summaryBody.push([
            {text: 'Item', style: 'tableHeader', border: [false, false, false, true]}, 
            {text: 'Description', style: 'tableHeader', border: [false, false, false, true]}, 
            {text: 'Amount', style: 'tableHeader', alignment: 'right', border: [false, false, false, true]}
        ]);

        quoteData.forEach((section, index) => {
            const sTotal = section.items.reduce((a, b) => a + (b.qty * b.price), 0);
            grandTotal += sTotal;
            summaryBody.push([
                {text: String.fromCharCode(65 + index), style: 'tableCellSummary', border: [false, false, false, false]},
                {text: section.title, style: 'tableCellSummary', border: [false, false, false, false]},
                {text: formatCurrency(sTotal), alignment: 'right', style: 'tableCellSummary', border: [false, false, false, false]}
            ]);
        });

        // 3. Build Detailed Tables Content
        const detailsBody = [
             [
                {text: 'S/N', style: 'tableHeader', fillColor: '#f1f5f9'}, 
                {text: 'Description', style: 'tableHeader', fillColor: '#f1f5f9'}, 
                {text: 'Unit', style: 'tableHeader', alignment: 'center', fillColor: '#f1f5f9'}, 
                {text: 'Rate', style: 'tableHeader', alignment: 'right', fillColor: '#f1f5f9'}, 
                {text: 'Amount', style: 'tableHeader', alignment: 'right', fillColor: '#f1f5f9'}
            ]
        ];

        let sn = 1;
        quoteData.forEach((section, sIndex) => {
            const sectionTotal = section.items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            
            // Section Header
            detailsBody.push([
                {text: `${String.fromCharCode(65 + sIndex)}. ${section.title}`, colSpan: 5, style: 'sectionHeader', fillColor: '#e2e8f0', margin: [0, 10, 0, 5]},
                {},{},{},{}
            ]);

            // Items
            section.items.forEach(item => {
                detailsBody.push([
                    {text: sn++, style: 'tableCell', color: '#64748b'},
                    {text: item.desc, style: 'tableCell'},
                    {text: `${item.qty} ${item.unit}`, alignment: 'center', style: 'tableCell'},
                    {text: formatCurrency(item.price), alignment: 'right', style: 'tableCell'},
                    {text: formatCurrency(item.qty * item.price), alignment: 'right', style: 'tableCell'}
                ]);
            });

            // Section Subtotal Row
            detailsBody.push([
                {text: '', border: [false, false, false, false]},
                {text: `Total for ${section.title}`, bold: true, alignment: 'right', colSpan: 3, style: 'tableCell', border: [false, false, false, false]},
                {},{},
                {text: formatCurrency(sectionTotal), bold: true, alignment: 'right', style: 'tableCell', border: [false, true, false, false]} // Top border only
            ]);
            
            // Spacer row
            detailsBody.push([
                {text: ' ', colSpan: 5, border: [false, false, false, false], fontSize: 5},{},{},{},{}
            ]);
        });

        // 4. Document Definition
        const docDefinition = {
            pageSize: 'A4',
            pageMargins: [40, 40, 40, 60],
            footer: function(currentPage, pageCount) {
                return {
                    text: `Page ${currentPage} of ${pageCount}`,
                    alignment: 'right',
                    fontSize: 8,
                    color: '#94a3b8',
                    margin: [0, 0, 40, 0]
                };
            },
            content: [
                // === PAGE 1: COVER SHEET ===
                {
                    columns: [
                        {
                            text: [
                                {text: 'RenoBros ', bold: true, fontSize: 24, color: '#0f172a'},
                                {text: 'Interior', bold: true, fontSize: 24, color: '#2563eb'}
                            ]
                        },
                        {
                            stack: [
                                {text: 'QUOTATION', fontSize: 14, bold: true, letterSpacing: 2, alignment: 'right'},
                                {text: quoteDate, fontSize: 10, alignment: 'right', margin: [0, 5, 0, 0]},
                                {text: 'Ref: ' + quoteRef, fontSize: 10, alignment: 'right', margin: [0, 2, 0, 0]}
                            ]
                        }
                    ],
                    margin: [0, 0, 0, 40]
                },
                
                { text: projectTitle.toUpperCase(), fontSize: 14, bold: true, color: '#0f172a', margin: [0, 0, 0, 25] },

                // Client Info Box
                {
                    canvas: [{ type: 'rect', x: 0, y: 0, w: 515, h: 65, r: 4, lineColor: '#e2e8f0' }],
                    absolutePosition: {x: 40, y: 165}
                },
                {
                    columns: [
                        { width: '15%', text: 'ATTN TO:', bold: true, fontSize: 10, color: '#64748b' },
                        { width: '85%', text: clientName.toUpperCase(), bold: true, fontSize: 11 }
                    ],
                    margin: [10, 10, 0, 5]
                },
                {
                    columns: [
                        { width: '15%', text: 'SITE:', bold: true, fontSize: 10, color: '#64748b' },
                        { width: '85%', text: address.toUpperCase(), bold: true, fontSize: 11 }
                    ],
                    margin: [10, 0, 0, 30]
                },

                // Summary Table
                { text: 'SUMMARY OF COSTS', style: 'subHeader', margin: [0,20,0,10] },
                {
                    table: { widths: ['10%', '60%', '30%'], body: summaryBody },
                    layout: {
                        hLineWidth: function(i) { return (i === 1) ? 1 : 0; },
                        vLineWidth: function(i) { return 0; },
                        paddingTop: function(i) { return 8; },
                        paddingBottom: function(i) { return 8; }
                    }
                },

                // Grand Total
                {
                    columns: [
                        { width: '*', text: '' },
                        {
                            width: 'auto',
                            table: {
                                widths: [120, 120],
                                body: [
                                    [
                                        {text: 'GRAND TOTAL', bold: true, alignment: 'right', fontSize: 11, margin:[0,5,0,5]}, 
                                        {text: formatCurrency(grandTotal), bold: true, alignment: 'right', fontSize: 13, color: '#0f172a', margin:[0,5,0,5]}
                                    ]
                                ]
                            },
                            layout: {
                                hLineWidth: function(i, node) { return (i === 0 || i === node.table.body.length) ? 1 : 0; },
                                vLineWidth: function(i) { return 0; }
                            }
                        }
                    ],
                    margin: [0, 20, 0, 0]
                },

                // === PAGE BREAK ===
                { text: '', pageBreak: 'after' },

                // === PAGE 2+: DETAILED BREAKDOWN ===
                {
                    text: 'DETAILED BREAKDOWN', 
                    style: 'subHeader', 
                    margin: [0, 0, 0, 15] 
                },
                {
                    table: {
                        widths: ['6%', '54%', '12%', '14%', '14%'],
                        headerRows: 1,
                        body: detailsBody
                    },
                    layout: {
                        hLineWidth: function (i, node) { return (i === 0 || i === 1) ? 1 : 0; }, // Header lines only
                        vLineWidth: function (i, node) { return 0; },
                        hLineColor: function (i, node) { return '#cbd5e1'; },
                        paddingTop: function(i) { return 6; },
                        paddingBottom: function(i) { return 6; }
                    }
                },

                // === LAST PAGE: SIGNATURE & TERMS ===
                { text: '', pageBreak: 'before' }, // Force new page for Terms/Sig if you prefer, or remove to flow naturally
                
                { text: 'TERMS & CONDITIONS', style: 'subHeader', margin: [0, 0, 0, 10] },
                {
                    ol: [
                        'This quotation is valid for 30 days from the date of issue.',
                        'Payment terms: 10% Deposit, 40% Commencement, 45% Progress, 5% Completion.',
                        'All cheques should be crossed and made payable to "RenoBros Interior Pte Ltd".',
                        'Any variation orders will be charged separately and must be approved in writing.',
                        'Work schedule to be agreed upon confirmation of order.'
                    ],
                    fontSize: 9,
                    color: '#475569',
                    margin: [0, 0, 0, 40]
                },

                // Signature Block
                {
                    table: {
                        widths: ['*', '*'],
                        body: [
                            [
                                { text: 'CONFIRMED & ACCEPTED BY:', fontSize: 10, bold: true, color: '#0f172a' },
                                { text: 'FOR RENOBROS INTERIOR:', fontSize: 10, bold: true, color: '#0f172a', alignment: 'right' }
                            ],
                            [
                                { text: '\n\n\n_____________________________\nClient Signature / Date', fontSize: 9, color: '#94a3b8' },
                                { text: '\n\n\n_____________________________\nAuthorised Signature', fontSize: 9, color: '#94a3b8', alignment: 'right' }
                            ]
                        ]
                    },
                    layout: 'noBorders'
                }
            ],
            styles: {
                tableHeader: { bold: true, fontSize: 9, color: '#1e293b', margin: [0, 4, 0, 4] },
                tableCell: { fontSize: 9, margin: [0, 4, 0, 4] },
                tableCellSummary: { fontSize: 10, margin: [0, 4, 0, 4], bold: true, color: '#334155' },
                sectionHeader: { bold: true, fontSize: 10, color: '#0f172a' },
                subHeader: { bold: true, fontSize: 11, color: '#64748b', letterSpacing: 1, decoration: 'underline' }
            },
            defaultStyle: { font: 'Roboto' }
        };

        // 5. Generate
        try {
            pdfMake.createPdf(docDefinition).download(`Quotation_${quoteRef}.pdf`);
        } catch (e) {
            console.error(e);
            alert("Error creating PDF");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
